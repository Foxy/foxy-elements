import { html } from 'lit-html';
import { unsafeHTML } from 'lit-html/directives/unsafe-html';

import {
  Subtitle,
  ArgsTable,
  Story,
  Canvas,
  Meta,
} from '@web/storybook-prebuilt/addon-docs/blocks.js';

import './index.ts';
import '../CustomerApi/index.ts';

<Meta
  title="Forms / AccessRecoveryForm"
  argTypes={{
    readonlycontrols: {
      control: {
        type: 'check',
        options: ['email', 'submit'],
      },
    },
    disabledcontrols: {
      control: {
        type: 'check',
        options: ['email', 'submit'],
      },
    },
    hiddencontrols: {
      control: {
        type: 'check',
        options: ['email', 'message', 'submit'],
      },
    },
    lang: {
      control: {
        type: 'select',
        options: ['en', 'es'],
      },
    },
  }}
/>

# AccessRecoveryForm

<Subtitle>Email-based "forgot password" form</Subtitle>

<Canvas
  mdxSource={`<foxy-access-recovery-form parent="foxy://auth/recover"></foxy-access-recovery-form>`}
  isExpanded
>
  <Story
    name="Playground"
    args={{
      readonlycontrols: [],
      disabledcontrols: [],
      hiddencontrols: [],
      readonly: false,
      disabled: false,
      lang: 'en',
      href: '',
      parent: 'foxy://auth/recover',
      'email:before': '',
      'email:after': '',
      'message:before': '',
      'message:after': '',
      'submit:before': '',
      'submit:after': '',
    }}
  >
    {args => html`
      <foxy-access-recovery-form
        disabledcontrols=${args.disabledcontrols.join(' ')}
        readonlycontrols=${args.readonlycontrols.join(' ')}
        hiddencontrols=${args.hiddencontrols.join(' ')}
        ?disabled=${args.disabled}
        ?readonly=${args.readonly}
        parent=${args.parent}
        class="container-narrow"
        href=${args.href}
        lang=${args.lang}
        @fetch=${evt =>
          evt.respondWith(
            new Promise(resolve =>
              setTimeout(() => resolve(new Response(null, { status: 200 })), 750)
            )
          )}
      >
        <div slot="email:before">${unsafeHTML(args['email:before'])}</div>
        <div slot="email:after">${unsafeHTML(args['email:after'])}</div>
        <div slot="message:before">${unsafeHTML(args['message:before'])}</div>
        <div slot="message:after">${unsafeHTML(args['message:after'])}</div>
        <div slot="submit:before">${unsafeHTML(args['submit:before'])}</div>
        <div slot="submit:after">${unsafeHTML(args['submit:after'])}</div>
      </foxy-access-recovery-form>
    `}
  </Story>
</Canvas>

## Reference

<ArgsTable of="foxy-access-recovery-form" />

### hAPI

This element is not meant to work with a specific Foxy Hypermedia endpoint. Instead, it addresses a virtual endpoint at `foxy://auth/recover` by sending a `POST` request with the following payload on submit:

```ts
type Payload = {
  /** Specifies detail type for API elements like foxy-customer-api. */
  type: 'email';
  /** Detail itself. */
  detail: {
    /** Valid email entered into the form. */
    email: string;
  };
};
```

As a developer, you must intercept this request by listening to the `fetch` event (same as in all Nucleon elements) and process using an auth backend of your choice. Respond with a `2XX` status on success, use `5XX` for backend errors. Here's an example using the Customer Portal API with our SDK:

```ts
import { API } from '@foxy.io/sdk/customer';

const api = new API({ base: new URL('https://my.store.domain/s/customer') });
const element = document.getElementById('my-form-id');

element.addEventListener('fetch', evt => {
  if (evt.request.url !== 'foxy://auth/recover') return;
  if (evt.request.method !== 'POST') return;

  evt.respondWith(
    evt.request
      .json()
      .then(({ detail })} => api.sendPasswordResetEmail(detail))
      .then(() => new Response(null, { status: 200 }))
      .catch(() => new Response(null, { status: 500 }))
  );
});
```

For the use case outlined above, you can also just wrap this form into `foxy-customer-api`:

```html
<foxy-customer-api base="https://my.store.domain/s/customer/">
  <foxy-access-recovery-form parent="https://my.store.domain/s/customer/forgot_password">
  </foxy-access-recovery-form>
</foxy-customer-api>
```

### i18next

This element supports the following namespaces: `access-recovery-form`, `shared`.

### Theming

Our elements are built with Vaadin Lumo theme and therefore share the list of CSS Custom Properties with it. You can find the latest documentation and theme editor on [demo.vaadin.com](https://demo.vaadin.com/lumo-editor/).
