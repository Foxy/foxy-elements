import dedent from 'dedent';
import { html } from 'lit-html';
import { unsafeHTML } from 'lit-html/directives/unsafe-html';

import {
  Subtitle,
  ArgsTable,
  Story,
  Canvas,
  Meta,
} from '@web/storybook-prebuilt/addon-docs/blocks.js';

import './index.ts';
import '../CustomerApi/index.ts';

<Meta
  title="Forms / SignInForm"
  argTypes={{
    readonlycontrols: {
      control: {
        type: 'check',
        options: ['email', 'password'],
      },
    },
    disabledcontrols: {
      control: {
        type: 'check',
        options: ['email', 'password', 'submit'],
      },
    },
    hiddencontrols: {
      control: {
        type: 'check',
        options: ['email', 'password', 'error', 'submit'],
      },
    },
    lang: {
      control: {
        type: 'select',
        options: ['en', 'es'],
      },
    },
  }}
/>

export const controlsWithSlots = ['email', 'password', 'error', 'submit'];

# SignInForm

<Subtitle>Form element for email/password sign in</Subtitle>

<Canvas
  isExpanded
  mdxSource={dedent`
    <foxy-customer-api base="https://demo.foxycart.com/s/customer/">
      <foxy-sign-in-form parent="foxy://auth/session"></foxy-sign-in-form>
    </foxy-customer-api>
  `}
>
  <Story
    name="Playground"
    args={{
      readonlycontrols: [],
      disabledcontrols: [],
      hiddencontrols: [],
      readonly: false,
      disabled: false,
      lang: 'en',
      href: '',
      parent: 'foxy://auth/session',
      ...controlsWithSlots.reduce(
        (args, control) => ({ ...args, [`${control}:before`]: '', [`${control}:after`]: '' }),
        {}
      ),
    }}
  >
    {args => html`
      <foxy-sign-in-form
        disabledcontrols=${args.disabledcontrols.join(' ')}
        readonlycontrols=${args.readonlycontrols.join(' ')}
        hiddencontrols=${args.hiddencontrols.join(' ')}
        ?disabled=${args.disabled}
        ?readonly=${args.readonly}
        parent=${args.parent}
        class="container-narrow"
        href=${args.href}
        lang=${args.lang}
      >
        ${controlsWithSlots.map(control => {
          return html`
            <div slot="${control}:before">${unsafeHTML(args[`${control}:before`])}</div>
            <div slot="${control}:after">${unsafeHTML(args[`${control}:after`])}</div>
          `;
        })}
      </foxy-sign-in-form>
    `}
  </Story>
</Canvas>

## Reference

<ArgsTable of="foxy-sign-in-form" />

### hAPI

This element is not meant to work with a specific Foxy Hypermedia endpoint. Instead, it addresses a virtual endpoint at `foxy://auth/session` by sending a `POST` request with the following payload on submit:

```ts
type Payload = {
  /** Specifies credential type for API elements like foxy-customer-api. */
  type: 'password';
  /** Credential itself. */
  credential: {
    /** Valid email entered into the form. */
    email: string;
    /** Non-empty password entered into the form. */
    password: string;
  };
};
```

As a developer, you must intercept this request by listening to the `fetch` event (same as in all Nucleon elements) and process using an auth backend of your choice. Respond with a `2XX` status if authenticated, `401` otherwise, use `5XX` for backend errors. Here's an example using the Customer Portal API with our SDK:

```ts
import { API } from '@foxy.io/sdk/customer';

async function handleRequest(request, api) {
  let json;

  try {
    json = await request.json();
    await api.signIn(json.credential);
  } catch (err) {
    const status = err.code === 'UNAUTHORIZED' ? 401 : 500;
    return new Response(null, { status });
  }

  json._links = { self: { href: request.url } };
  return new Response(JSON.stringify(json));
}

const api = new API({ base: new URL('https://my.store.domain/s/customer') });
const form = document.getElementById('my-form-id');

form.addEventListener('fetch', evt => {
  if (evt.request.url !== 'foxy://auth/session') return;
  if (evt.request.method !== 'POST') return;

  evt.respondWith(handleRequest(evt.request, api));
});
```

For the use case outlined above, you can also just wrap this form into `foxy-customer-api`:

```html
<foxy-customer-api base="https://my.store.domain/s/customer/">
  <foxy-sign-in-form parent="foxy://auth/session"></foxy-sign-in-form>
</foxy-customer-api>
```

### i18next

This element supports the following namespaces: `sign-in-form`, `shared`.

### Theming

Our elements are built with Vaadin Lumo theme and therefore share the list of CSS Custom Properties with it. You can find the latest documentation and theme editor on [demo.vaadin.com](https://demo.vaadin.com/lumo-editor/).

<Story name="Code 401" parameters={{ docs: { disable: true } }}>
  {() => html`
    <foxy-sign-in-form
      class="container-narrow"
      @fetch=${evt => {
        evt.respondWith(
          new Promise(resolve => {
            setTimeout(() => resolve(new Response(null, { status: 401 })), 750);
          })
        );
      }}
    >
    </foxy-sign-in-form>
  `}
</Story>

<Story name="Code 500" parameters={{ docs: { disable: true } }}>
  {() => html`
    <foxy-sign-in-form
      class="container-narrow"
      @fetch=${evt => {
        evt.respondWith(
          new Promise(resolve => {
            setTimeout(() => resolve(new Response(null, { status: 500 })), 750);
          })
        );
      }}
    >
    </foxy-sign-in-form>
  `}
</Story>
