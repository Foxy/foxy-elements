import dedent from 'dedent';
import { html } from 'lit-html';

import {
  Subtitle,
  ArgsTable,
  Story,
  Canvas,
  Meta,
} from '@web/storybook-prebuilt/addon-docs/blocks.js';

import './index.ts';
import '../CustomerApi/index.ts';

<Meta title="Forms / SignInForm" />

# SignInForm

<Subtitle>Form element for email/password sign in</Subtitle>

<Canvas mdxSource={dedent`<foxy-sign-in-form></foxy-sign-in-form>`} isExpanded>
  <Story name="Playground">
    {() => html`
      <foxy-sign-in-form
        class="container-narrow"
        @fetch=${evt =>
          evt.respondWith(
            new Promise(resolve =>
              setTimeout(() => resolve(new Response(null, { status: 200 })), 750)
            )
          )}
      >
      </foxy-sign-in-form>
    `}
  </Story>
</Canvas>

## Reference

<ArgsTable of="foxy-sign-in-form" />

### hAPI

This element is not meant to work with a specific Foxy Hypermedia endpoint. Instead, it addresses a virtual endpoint at `foxy://auth/session` by sending a `POST` request with the following payload on submit:

```ts
type Payload = {
  /** Specifies credential type for API elements like foxy-customer-api. */
  type: 'password';
  /** Credential itself. */
  credential: {
    /** Valid email entered into the form. */
    email: string;
    /** Non-empty password entered into the form. */
    password: string;
  };
};
```

As a developer, you must intercept this request by listening to the `fetch` event (same as in all Nucleon elements) and process using an auth backend of your choice. Respond with a `2XX` status if authenticated, `401` otherwise, use `5XX` for backend errors. Here's an example using the Customer Portal API with our SDK:

```ts
import { API } from '@foxy.io/sdk/customer';

const api = new API({ base: new URL('https://my.store.domain/s/customer') });
const element = document.getElementById('my-form-id');

element.addEventListener('fetch', evt => {
  if (evt.request.url !== 'foxy://auth/session') return;
  if (evt.request.method !== 'POST') return;

  evt.respondWith(
    evt.request
      .json()
      .then(({ credential })} => api.signIn(credential))
      .catch(({ code }) => (code === 'UNAUTHORIZED' ? 401 : 500))
      .then((status = 200) => new Response(null, { status }))
  );
});
```

For the use case outlined above, you can also just wrap this form into `foxy-customer-api`:

```html
<foxy-customer-api base="https://my.store.domain/s/customer/">
  <foxy-sign-in-form></foxy-sign-in-form>
</foxy-customer-api>
```

### i18next

This element supports the following namespaces: `sign-in-form`, `shared`.

### Theming

Our elements are built with Vaadin Lumo theme and therefore share the list of CSS Custom Properties with it. You can find the latest documentation and theme editor on [demo.vaadin.com](https://demo.vaadin.com/lumo-editor/).

<Story name="Code 401" parameters={{ docs: { disable: true } }}>
  {() => html`
    <foxy-sign-in-form
      password="foobarbaz"
      email="foo@example.com"
      @fetch=${evt => evt.respondWith(Promise.resolve(new Response(null, { status: 401 })))}
    >
    </foxy-sign-in-form>
  `}
</Story>

<Story name="Code 500" parameters={{ docs: { disable: true } }}>
  {() => html`
    <foxy-sign-in-form
      password="foobarbaz"
      email="foo@example.com"
      @fetch=${evt => evt.respondWith(Promise.resolve(new Response(null, { status: 500 })))}
    >
    </foxy-sign-in-form>
  `}
</Story>
